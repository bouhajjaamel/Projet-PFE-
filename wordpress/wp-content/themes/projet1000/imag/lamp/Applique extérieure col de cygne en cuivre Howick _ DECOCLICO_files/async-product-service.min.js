!function(){"use strict";angular.module("async.product.service",[]).factory("AsyncProductService",["$rootScope","$location","$timeout","$filter","productService","AppService","ModalService","DateService","HttpService",function(a,i,r,n,c,u,d,s,l){return{initModule:function(r,o){function e(){d.show("/Template/Modal/ModalQuickView",{url:r.url},"lg",null,null,r.device)}(function(){r.galleryImgLoader=!1,r.zoomLoaded=!1;var t=c.getProduct(),e={idProduct:r.id,isPrimary:r.isPrimary,isCustomizable:r.isCustomizable,isNumeric:r.isNumeric,designation:r.designation,refProduct:r.ref,img:r.img};if(c.setProduct(r.idGroup,_.merge(t[r.idGroup],e)),r.addToCartActive=c.getActive(),r.modalCtrl&&r.modalCtrl.quantity){r.modalCtrl.data.id=r.id,r.modalCtrl.productsData=r.getProductsToAdd(r.modalCtrl.quantity,r.modalCtrl.quantity),r.modalCtrl.addToCartActive=r.addToCartActive;var o=r.modalCtrl.data.url.split("-p-")[1],i=o.slice(o.indexOf("/"));i===r.modalCtrl.updateFromCart&&(r.modalCtrl.addToCartActive=!1)}u.getParams().then(function(t){r.showTTCPrice=t.Visitor.CardType.ShowTTCPrice,r.showEcoContribution=!0,t.IsLogged&&(window.ScarabQueue=window.ScarabQueue||[],ScarabQueue.push(["setEmail",t.Visitor.Email]),t.Cart?ScarabQueue.push(["cart",t.Cart.Products.map(function(t){return{item:t.Product.Reference,price:t.Product.Price.TTCDiscountedPrice,quantity:t.Quantity}})]):ScarabQueue.push(["cart",[]]),ScarabQueue.push(["view",r.ref.toString()]),ScarabQueue.push(["go"]))}).catch(function(t){})})(),o.$on("updateProduct",function(){r.addToCartActive=c.getActive()}),o.$on("updateNbReviews",function(t,e){r.nbReviews=e}),r.setPricesData=function(t,e){r.prices=t,r.eco=e,r.setPrice(r.quantity)},r.setPrice=function(e){var t=c.getProduct()[r.idGroup];r.costHT=0,r.costTTC=0,t&&_.each(t.elements,function(t){r.costHT+=t.costHT||0,r.costTTC+=t.costTTC||0}),_.each(r.prices,function(t){if(_.inRange(e,t.range[0],t.range[1]||1e4))return r.Price=t,r.Price.EcoContribution=r.eco,c.setProductPrice(r.idGroup,r.Price,r.costTTC,r.costHT,r.showTTCPrice,r.prices),!1})},r.changeAttribute=function(){var e=r.urlGroup;if(_.each(r.attributes,function(t){e=""===t?e:e+"/"+t}),r.modalCtrl){r.modalCtrl.productsData=r.getProductsToAdd(r.modalCtrl.quantity,r.modalCtrl.quantity),o.modalCtrl.showLoader=!0,o.modalCtrl.data.url=e;var t=$(".modal-quick-view .modal-body");t.css({height:t.height()+"px"})}else i.path(e).replace()},r.setInputQuantity=function(t){r.quantity=t||1,r.setPrice(t)},r.setCustomization=function(t,e){var i,n=!0;r.costTTC=0,r.costHT=0,_.each(t.Items,function(t){if(!t.Group){if(1===t.Field.CustomizationType&&-1!==t.Field.Code.indexOf("Date")){var e=t.Field.Value.getMonth()<9?"0"+(t.Field.Value.getMonth()+1):t.Field.Value.getMonth()+1,o=t.Field.Value.getDate()<10?"0"+t.Field.Value.getDate():t.Field.Value.getDate();t.Field.Value=s.stringToDate(t.Field.Value.getFullYear()+"-"+e+"-"+o+"T23:59:00")}t.Field.Value&&""!==t.Field.Value?(r.costTTC+=t.Field.AdditionalCostTTC,r.costHT+=t.Field.AdditionalCostHT,3===t.Field.CustomizationType&&(i=_.find(t.Field.Items,{IDCustomizationListItem:parseInt(t.Field.Value)}),r.costTTC+=i.AdditionalCostTTC,r.costHT+=i.AdditionalCostHT)):t.Field.Required&&(n=!1)}t.Group&&_.each(t.Group.Fields,function(t){t.Value&&""!==t.Value?(r.costTTC+=t.AdditionalCostTTC,r.costHT+=t.AdditionalCostHT,3===t.CustomizationType&&(i=_.find(t.Items,{IDCustomizationListItem:parseInt(t.Value)}),r.costTTC+=i.AdditionalCostTTC,r.costHT+=i.AdditionalCostHT)):t.Required&&(n=!1)})}),r.setPrice(r.quantity),n?(o.$broadcast("updateTooltip"),r.addToCartActive=!0):(o.$broadcast("updateTooltip",e),r.addToCartActive=!1),r.allowAddToCart||(r.addToCartActive=!1),c.setProductCustomization(r.idGroup,t),o.$broadcast("updateComment",c.getProduct()[r.idGroup].Comment)},r.setQuantity=function(t){r.quantity=t,c.setProductQuantity(r.idGroup,t)},r.getProductsToAdd=function(t,e){return r.quantity=t,r.setPrice(t),r.setQuantity(e),c.getProductsData()},r.setActiveTab=function(t){r.active=t},r.giftlist=function(t){},r.openCmsLoyalty=function(){d.show("/Template/Modal/ModalCms",{url:"/page-cms/programme-fidelite"},"lg",null,null,null,{modalTitle:"Points fidélité",modalAutoScroll:!1})},r.openModalReviews=function(t){d.show("/Template/Product/ModalReviews",{id:t},null,"modalReviewsCtrl")},r.openShippingInfos=function(t){d.close(),d.show("/Template/Product/ModalShippingsProduct",{idProduct:r.id},null,null,null,r.device,null,t?e:null)}},initPrice:function(n){r(function(){var o=[{qty:1,range:[0],HasDiscount:n.jsonPrice.HasDiscount,Discount:n.jsonPrice.Discount,HTDiscountedPrice:n.jsonPrice.HTDiscountedPrice,TTCDiscountedPrice:n.jsonPrice.TTCDiscountedPrice,HTPrice:n.jsonPrice.HTPrice,TTCPrice:n.jsonPrice.TTCPrice}];if(n.jsonPrice.DegressivePrice){var i=0;_.each(n.jsonPrice.DegressivePrice,function(t,e){o[i].range.push(Number(e)),o[i].caption=0===i?n.txtFirstRange.replace("{0}",String(e)):n.txtRange.replace("{0}",String(o[i].range[0])).replace("{1}",String(e-1)),o.push({qty:Number(e),range:[Number(e)],caption:n.txtLastRange.replace("{0}",String(e)),HasDiscount:t.HasDiscount,Discount:t.Discount,HTDiscountedPrice:t.HTDiscountedPrice,TTCDiscountedPrice:t.TTCDiscountedPrice,HTPrice:t.HTPrice,TTCPrice:t.TTCPrice}),i++})}n.prices=o,n.productCtrl.setPricesData(o,n.jsonPrice.EcoContribution)})},initCustomization:function(o,t,e){o.showTTCPrice=o.productCtrl.showTTCPrice,o.device=o.productCtrl.device,r(function(){var t=c.getProductCustomisation(o.productCtrl.idGroup);t?o.model=t:_.each(o.model.Items,function(t){t.Group||(1===t.Field.CustomizationType&&-1!==t.Field.Code.indexOf("Date")&&(t.Field.isDate=!0,o.isCheque&&(t.Field.Value=new Date((new Date).setHours(23,59))),t.Field.reqPlaceholder=t.Field.Required?" *":""),3===t.Field.CustomizationType&&_.each(t.Field.Items,function(t){t.content=t.Designation,o.showTTCPrice&&t.AdditionalCostTTC&&(t.content=t.Designation+'<span class="small"> (+ '+n("price")(t.AdditionalCostTTC,"value")+")</span>",t.content=t.content.replace(/"/g,"'")),!o.showTTCPrice&&t.AdditionalCostHT&&(t.content=t.Designation+'<span class="small"> (+ '+n("price")(t.AdditionalCostHT,"value","ht")+")</span>",t.content=t.content.replace(/"/g,"'"))})),t.Group&&_.each(t.Group.Fields,function(t){1===t.CustomizationType&&-1!==t.Code.indexOf("Date")&&(t.isDate=!0,t.reqPlaceholder=t.Required?" *":""),3===t.CustomizationType&&_.each(t.Items,function(t){t.content=t.Designation,o.showTTCPrice&&t.AdditionalCostTTC&&(t.content=t.Designation+'<span class="small"> (+ '+n("price")(t.AdditionalCostTTC,"value")+")</span>",t.content=t.content.replace(/"/g,"'")),!o.showTTCPrice&&t.AdditionalCostHT&&(t.content=t.Designation+'<span class="small"> (+ '+n("price")(t.AdditionalCostHT,"value","ht")+")</span>",t.content=t.content.replace(/"/g,"'"))})})}),setTimeout(function(){e.find("select.refresh").each(function(t,e){$(e).selectpicker("refresh")})}),o.update(),o.init=!0}),o.dateOptions={showWeeks:!1,minDate:new Date,yearRows:2},o.dateFormat="dd/MM/yyyy",o.successfile=function(t,e){e.Value=t.name,e.Comment=t.serverName,o.update()},o.removedfile=function(t){t.Value="",t.Comment="",o.update()},o.update=function(){o.productCtrl.setCustomization(o.model,o.tooltip)}},initKit:function(r,t,e){function o(t){r.showLoader=!0,l.post({url:"/Product/GetComponents",data:t}).then(function(t){if("OK"===t.status){r.Components=[];var i={},n=0;_.each(t.results,function(e){if(e.Type){if(i[e.Id]||(i[e.Id]=!0,e.groupTitle=e.Designation,e.groupFirstElement=!0),(901===e.Type||903===e.Type)&&!e.Product)return;if(902===e.Type){var t=_.find(e.Elements,function(t){return t.Product.IDProduct===e.IDProductDefault&&t.Product.AllowAddToCart});e.groupFirstElement&&t&&r.selectCustomComponent(e,t)}}else{var o=e.KitQuantity;e={Product:e,Quantity:o}}(901!==e.Type&&903!==e.Type||e.Product)&&(e.uniqueId=e.Product?e.Product.IDProduct+"_"+n:e.Id+"_"+n,r.attributes[e.uniqueId]=[],function(e){if(901===e.Type||902===e.Type)e.isPrimary=!0,e.currentModel=e.Product;else if(903===e.Type){if(e.isPrimary=!!e.Product&&(!e.Product.IsGroupingProduct||e.Product.IsGroupingProduct&&null!==e.Product.SelectedProduct),e.currentModel=e.Product?e.Product.SelectedProduct||e.Product:null,e.Attributes=e.Product?e.Product.Attributes:null,e.isPrimary){var o=0;_.each(e.Attributes,function(t){r.attributes[e.uniqueId][o]=_.find(t.Values,{Selected:!0}).Key,o++})}}else e.Type||(e.isPrimary=!e.Product.IsGroupingProduct||e.Product.IsGroupingProduct&&null!==e.Product.SelectedProduct,e.currentModel=e.Product.SelectedProduct||e.Product);c.setKitElement(r.idKit,e)}(e),r.Components.push(e)),n++}),setTimeout(function(){e.find("select.refresh").each(function(t,e){$(e).selectpicker("refresh")})}),a.$broadcast("updateProduct"),a.$broadcast("updateComment",c.getProduct()[r.idKit].Comment)}r.showLoader=!1}).catch(function(t){})}function n(t){c.setKitElement(r.idKit,t),a.$broadcast("updateProduct"),a.$broadcast("updateComment",c.getProduct()[r.idKit].Comment)}o(r.idKit),r.attributes={},r.changeAttribute=function(e){var o=_.find(r.Components,function(t){return t.uniqueId===e}),i=o.URL||o.Product.URL;_.each(r.attributes[e],function(t){i=""===t?i:i+"/"+t}),_.includes(i,"?")?i+="&checkVisibility=false":i+="?checkVisibility=false",o.showLoader=!0,l.get({url:i,cache:!0}).then(function(t){o.Product=t,o.isPrimary=!o.Product.IsGroupingProduct||o.Product.IsGroupingProduct&&null!==o.Product.SelectedProduct,o.currentModel=o.Product.SelectedProduct||o.Product,n(o),o.showLoader=!1}).catch(function(t){})},r.selectCustomComponent=function(t,e){e&&!e.Product.AllowAddToCart||(t.Product=e?e.Product:null,t.currentModel=e?t.Product:null,t.AdditionalCostHT=e?e.AdditionalCostHT:0,t.AdditionalCostTTC=e?e.AdditionalCostTTC:0,n(t))}},buttonSetItemQuantity:function(t){t.productCtrl.setInputQuantity(t.quantity)}}}]).factory("productService",function(){var a={};return{setProduct:function(t,e){(a={})[t]=e},setProductQuantity:function(t,e){a[t].quantity=e},setProductPrice:function(t,e,o,i,n,r){a[t].Price=e,a[t].costTTC=o,a[t].costHT=i,a[t].showTTCPrice=n,a[t].prices=r},setProductCustomization:function(t,e){a[t].Customization=e;var o=_.cloneDeep(e);_.each(o.Items,function(t){t.Group||(t.Field.Comment=null),t.Group&&_.each(t.Group.Fields,function(t){t.Comment=null})}),a[t].Comment=md5(angular.toJson(o))},setKitElement:function(t,e){if(!e.Type||901!==e.Type||903!==e.Type||e.Required||e.Product){var o=a[t];o.elements||(o.elements={}),o.elements[e.uniqueId]||(o.elements[e.uniqueId]={}),o.elements[e.uniqueId]={idKitComponent:e.Id||0,type:e.Type,idProduct:e.Product?e.currentModel.IDProduct:0,quantity:e.Quantity,isPrimary:e.isPrimary,allowAddToCart:!!e.currentModel&&e.currentModel.AllowAddToCart,required:e.Required||!1,costHT:e.AdditionalCostHT||0,costTTC:e.AdditionalCostTTC||0},o.Elements=[],_.each(o.elements,function(t){t.isPrimary&&0!==t.idProduct&&o.Elements.push({IDKitComponent:t.idKitComponent,IDProduct:t.idProduct,Quantity:t.quantity})}),o.Comment=md5(angular.toJson(o.Elements))}},getProduct:function(){return a},getProductsData:function(){var e=[];return _.each(a,function(t){e.push(t)}),e},getProductCustomisation:function(t){return a[t]&&a[t].Customization?a[t].Customization:null},getActive:function(){var e=!0;return _.each(a,function(t){if(!t.isPrimary||t.isCustomizable)return e=!1;_.each(t.elements,function(t){if(t.type){if(901===t.type||903===t.type){if(t.required&&!t.allowAddToCart)return e=!1}else if(902===t.type&&t.required&&!t.allowAddToCart)return e=!1}else if(!t.allowAddToCart)return e=!1})}),e}}}).controller("modalReviewsCtrl",["data","device","options","HttpService",function(t,e,o,i){var n=this;n.data=t,n.showLoader=!0,i.get({url:"/Reviews/"+n.data.id+"/0/100/RateDESC/0",cache:!1}).then(function(t){n.data=t,n.showLoader=!1}).catch(function(t){})}]).controller("modalQuestionCtrl",["data","device","options","HttpService","AppService","ModalService","toastr",function(t,e,o,i,n,r,a){var c,u=this;u.data=t,u.successMessage=function(t){c=t},n.getParams().then(function(t){t.IsLogged&&(u.data.Email=t.Visitor.Email,u.data.FirstName=t.Visitor.FirstName,u.data.LastName=t.Visitor.LastName)}).catch(function(t){}),u.submit=function(){u.loading=!0,i.post({url:"/Product/QuestionProduct",data:u.data}).then(function(e){n.getTranslate().then(function(t){"OK"===e.status?(r.close(),a.success("",c,{allowHtml:!0,extraData:{template:"toast_message.tpl"}})):a.warning(t.errors.TryLater,t.errors.ErrorHasOccurred,{allowHtml:!0,extraData:{template:"toast_message.tpl"}}),u.loading=!1}).catch(function(t){})}).catch(function(t){})}}]).controller("modalSendToAFriendCtrl",["data","device","options","HttpService","AppService","ModalService","toastr",function(t,e,o,i,n,r,a){var c=this;c.data=t,n.getParams().then(function(t){t.IsLogged&&(c.data.FirstName=t.Visitor.FirstName,c.data.Email=t.Visitor.Email)}).catch(function(t){}),c.submit=function(){c.loading=!0,i.post({url:"/Product/SendToAFriend",data:c.data}).then(function(e){n.getTranslate().then(function(t){"OK"===e.status?(r.close(),a.success("",t.messages.MessageSent,{allowHtml:!0,extraData:{template:"toast_message.tpl"}})):a.warning(t.errors.TryLater,t.errors.ErrorHasOccurred,{allowHtml:!0,extraData:{template:"toast_message.tpl"}}),c.loading=!1}).catch(function(t){})}).catch(function(t){})}}])}();